<!DOCTYPE html>
<html lang="en">
<!-- [Previous head and style sections remain exactly the same] -->
<head>
  <!-- [Previous head content remains exactly the same] -->
</head>
<body>
  <div id="loading-screen"></div>
  <div id="ar-scene">
    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta:0.001"
      embedded
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      <a-assets timeout="30000">
        <video id="vid1" src="assets/asset.mp4" preload="auto" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
        <video id="vid2" src="assets/asset2.mp4" preload="auto" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
        <video id="vid3" src="assets/asset3.mp4" preload="auto" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
        <video id="vid4" src="assets/asset4.mp4" preload="auto" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
        <video id="vid5" src="assets/asset5.mp4" preload="auto" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
        <video id="vid6" src="assets/asset6.mp4" preload="auto" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
        <video id="vid7" src="assets/asset7.mp4" preload="auto" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
      </a-assets>

      <!-- [Previous a-entity sections remain exactly the same] -->

    </a-scene>
  </div>
  <div id="playButton" class="play-button"></div>

  <script>
    AFRAME.registerComponent('video-material', {
      // [Previous schema and shader code remains exactly the same]
    });

    document.addEventListener('DOMContentLoaded', function() {
      const targets = Array.from({ length: 7 }, (_, i) => ({
        video: document.getElementById(`vid${i + 1}`),
        entity: document.querySelector(`a-entity[mindar-image-target="targetIndex: ${i}"]`),
        plane: document.querySelector(`a-entity[mindar-image-target="targetIndex: ${i}"] a-plane`)
      }));

      const playButton = document.getElementById('playButton');
      const loadingScreen = document.getElementById('loading-screen');
      let currentTarget = null;
      let targetFound = false;

      // Preload all videos
      targets.forEach(target => {
        target.video.load();
        // Prepare video by loading a bit of data
        target.video.currentTime = 0.1;
      });

      document.querySelector('a-scene').addEventListener('arReady', () => {
        loadingScreen.style.display = 'none';
      });

      function pauseAllVideosExcept(activeVideo) {
        targets.forEach(t => {
          if (t.video !== activeVideo) {
            t.video.pause();
            t.video.currentTime = 0;
          }
        });
      }

      playButton.addEventListener('click', () => {
        if (currentTarget && targetFound) {
          playButton.style.display = 'none';
          currentTarget.plane.setAttribute('visible', true);
          // Try to play the video immediately
          currentTarget.video.play().catch(() => {
            // If autoplay fails, try one more time after a short delay
            setTimeout(() => {
              currentTarget.video.play().catch(() => {
                playButton.style.display = 'flex';
              });
            }, 100);
          });
        }
      });

      targets.forEach(target => {
        target.entity.addEventListener('targetFound', () => {
          targetFound = true;
          currentTarget = target;
          pauseAllVideosExcept(target.video);
          
          // Reset video state when target is found
          target.video.currentTime = 0;
          playButton.style.display = 'flex';
        });

        target.entity.addEventListener('targetLost', () => {
          if (currentTarget === target) {
            targetFound = false;
            target.video.pause();
            target.video.currentTime = 0;
            playButton.style.display = 'none';
            target.plane.setAttribute('visible', false);
            currentTarget = null;
          }
        });

        target.video.addEventListener('play', () => {
          pauseAllVideosExcept(target.video);
        });

        target.video.addEventListener('ended', () => {
          if (target.video.loop) {
            target.video.currentTime = 0;
            target.video.play().catch(() => {});
          }
        });

        target.video.muted = false;
      });
    });
  </script>
</body>
</html>
